# 1. CLI design

Date: 2023-05-28

## Status

Final

## Context

Building official curl images was previously achieved via https://github.com/curl/curl-docker. This set of Makefile and
scripts are adhoc, hard to maintain and makes it difficult to extend and/or create new image variations.

Goals of a new approach should be:

* clear demarcation between builder, base and appliance image
* provision of multi arch for base and appliance images
* enable signing/verifying of images
* enable easily pushing to multiple registries
* better testing
* all builds and releases should be side effect of CI job

One other goal is to ensure this infrastructure is not overly dependent on any specific features of any OCI implementation.


## Container Build Design

Using [buildah](https://buildah.io/), we can create reusable and parameterised set of scripts building a hiearchy of 
container images.

```commandline
├─ dev image: instant development image.
│  ├─ base image: curl base image to be used in docker inheritance.
│  │  ├─ curl image: curl 'appliance' image.
```

Publish daily in github registry:
* curl-container/curl:master: The curl 'appliance' image.
* curl-container/curl/curl-base:master: Base image for curl.
* curl-container/curl/curl-dev:master: Development image for curl.
* curl-container/curl/curl-multi:master: multi arch curl image.
* curl-container/curl/curl-base-multi:master: multi arch curl-base image.

Making it easy to test latest curl master branch.

The official images distributed via [Quay.io](https://quay.io/repository/curl/curl) and [hub.docker.com](https://hub.docker.com/repository/docker/curlimages/curl):
* curl:{release} = multi arch curl 'appliance' image
* curl-base:{release} = multi arch curl-base image


## Decision(s)

Create a new github repo - [curl/curl-container](https://github.com/curl/curl-container) and deprecate the old one ([curl/curl-docker](https://github.com/curl/curl-docker)).

All commits to this new repo require raising of a PR, review and signed commits.

Add CHANGELOG

Design and create container image build process using [buildah](https://buildah.io/)

Use [sigstore](https://www.sigstore.dev/) for signing and verifying fo all images generated by this process

Ensure both podman and docker work equally well.

## Consequences

We could keep the status quo (eg. ugly bash/makefile) though it is hard to maintain... also 

We could have opted for other container build frameworks/language or other adjuncts (ex. [skopeo](https://github.com/containers/skopeo)) ... 
buildah seemed to have the right set of features and mature ... perhaps in the future we will have even more choices.

Presumably we could have gone full 'code as infrastructure' and invoke buildah programmatically ... opted for shell scripts
for simplicity.